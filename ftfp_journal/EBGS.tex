%% NEW VERSION
% marek Thu Nov 29 12:16:01 PST 2012
%          still a lot of work needed. 


\section{Algorithm~{\EBGS} with Ratio $1.575$}\label{sec: 1.575-approximation}

In this section we give our main result, a $1.575$-approximation
algorithm for $\FTFP$, where $1.575$ is the value of $\min_{\gamma\geq
  1}\max\{\gamma, 1+2/e^\gamma, \frac{1/e+1/e^\gamma}{1-1/\gamma}\}$,
rounded to three decimal digits. This matches the ratio of the best
known LP-rounding algorithm for UFL by
Byrka~{\etal}~\cite{ByrkaGS10}. Recall that in Section~\ref{sec:
  1.736-approximation} we showed how to compute an integral solution
with facility cost bounded by $F^\ast$ and connection cost bounded by
$C^\ast + 2/e\cdot\LP^\ast$. A natural idea is to balance these two
costs, by reducing the connection cost at the expense of a slight
increase in the facility cost.

Consider that we start with the same partitioned fractional solution
$(\barbfx, \barbfy)$ produced by Pseudocode~\ref{alg:lpr2}, in the
rounding process, if we open a facility $\mu$ with probability
$\gamma\bary_{\mu}$ for some constant $\gamma > 1$, it can be shown
that, for a non-primary demand, the probability that we have to use an
indirect connection to its target facility is now bounded by
$1/e^\gamma$ instead of $1/e$. Moreover, the expected connection cost
of a primary demand $\kappa$ is now averaged over the closest
facilities in $\wbarN(\kappa)$ with total connection value
$\barx_{\mu\kappa}$ equal to $1/\gamma$, instead of $1$. So we will
have a much improved estimate on the expected connection cost. It is
also natural to go one step further by modifying our adaptive
partitioning algorithm slightly to produce a fractional solution with
a more refined overlap structure of the neighborhood of demands, and
hoping to get an even better estimate on the expected connection cost.

Our approach can be thought of as a combination of the ideas
in~\cite{ByrkaGS10} with the techniques of demand reduction and
adaptive partitioning that we introduced earlier. However, our
adaptive partitioning technique needs to be carefully modified,
because now we will be using a more intricate neighborhood structure,
with the neighborhood of each demand divided into two disjoint parts,
and with some restrictions on how parts from different demands can
overlap. The final rounding stage that construct an integral solution
is a relatively straightforward generalization of the rounding method
in~\cite{ByrkaGS10}.

We begin by describing properties that our partitioned fractional
solution $(\barbfx,\barbfy)$ needs to satisfy. As mentioned earlier, the neighborhood
$\wbarN(\nu)$ of each demand $\nu$ will be divided into two disjoint
parts.  The first part, called the \emph{close neighborhood} and denoted
$\wbarclsnb(\nu)$, contains the facilities in $\wbarN(\nu)$ nearest to
$\nu$ with the total connection value equal $1/\gamma$. The second
part, called the \emph{far neighborhood} and denoted $\wbarfarnb(\nu)$, contains
the remaining facilities in $\wbarN(\nu)$. Formal definitions of
these sets are given below in Property~(NB).  The respective average
connection costs from $\nu$ for these sets are defined by
%
\begin{equation*}
\clsdist(\nu)=\gamma\sum_{\mu\in\wbarclsnb(\nu)}
			d_{\mu\nu}\barx_{\mu\nu} \quad\text{and}\quad
\fardist(\nu)=\frac{\gamma}{\gamma-1}\sum_{\mu\in\wbarfarnb(\nu)}
d_{\mu\nu}\barx_{\mu\nu}. 
\end{equation*}
%
Note that $\sum_{\mu\in\wbarclsnb(\nu)} \barx_{\mu\nu} = 1/\gamma$ and
$\sum_{\mu\in\wbarfarnb(\nu)} = 1-1/\gamma$.  We will also use
notation $\clsmax(\nu)=\max_{\mu\in\wbarclsnb(\nu)} d_{\mu\nu}$ for
the maximum distance from $\nu$ to its close neighborhood.

Our partitioned solution $(\barbfx,\barbfy)$ must satisfy the same
partitioning and completeness properties as before, namely properties
(PS) and (CO) in Section~\ref{sec: adaptive partitioning}.  In
addition, it must satisfy a new neighborhood property (NB) and modified
properties (PD') and (SI'), listed below.

\begin{description}
	
      \renewcommand{\theenumii}{(\alph{enumii})}
      \renewcommand{\labelenumii}{\theenumii}

\item{(NB)} \label{NB}
	\emph{Neighborhoods.}
	For each demand $\nu$, its neighborhood is divided into \emph{close} and
	\emph{far} neighborhood, that is $\wbarN(\nu) = \wbarclsnb(\nu) \cup \wbarfarnb(\nu)$, where
	%
	\begin{itemize}
	\item $\wbarclsnb(\nu) \cap \wbarfarnb(\nu) = \emptyset$,
	\item $\sum_{\mu\in\wbarclsnb(\nu)} \barx_{\mu\nu} =1/\gamma$, and 
	\item if $\mu\in \wbarclsnb(\nu)$ and $\mu'\in \wbarfarnb(\nu)$ 
				then $d_{\mu\nu}\le d_{\mu'\nu}$.   
	\end{itemize}
	%
	Note that the second condition, together with (PS.\ref{PS:one}), implies
	that $\sum_{\mu\in\wbarfarnb(\nu)} \barx_{\mu\nu} =1-1/\gamma$.

\item{(PD')} \emph{Primary demands.}
	Primary demands satisfy the following conditions:

	\begin{enumerate}
		
	\item\label{PD1:disjoint}  For any two different primary demands $\kappa,\kappa'\in P$ we have
				$\wbarclsnb(\kappa)\cap \wbarclsnb(\kappa') = \emptyset$.

	\item \label{PD1:yi} For each site $i\in\sitesset$, 
		$ \sum_{\kappa\in P}\sum_{\mu\in
                  i\cap\wbarclsnb(\kappa)}\barx_{\mu\kappa} \leq
                y_i^\ast$. Note that in the summation, we use $i$ to
                refer to all facilities resulting from split from the
                facility on site $i$.
		
	\item \label{PD1:assign} Each demand $\nu\in\demandset$ is assigned
        to one primary demand $\kappa\in P$ such that

  			\begin{enumerate}
	
				\item \label{PD1:assign:overlap} $\wbarclsnb(\nu) \cap \wbarclsnb(\kappa) \neq \emptyset$, and
				%
				\item \label{PD1:assign:cost}
          $\clsdist(\nu)+\clsmax(\nu) \geq
          \clsdist(\kappa)+\clsmax(\kappa)$.
          %
			\end{enumerate}

	\end{enumerate}
	
\item{(SI')} \emph{Siblings}. For any pair $\nu,\nu'$ of different siblings we have
  \begin{enumerate}

	\item \label{SI1:siblings disjoint}
		  $\wbarN(\nu)\cap \wbarN(\nu') = \emptyset$.
		
	\item \label{SI1:primary disjoint} If $\nu$ is assigned to a primary demand $\kappa$ then
 		$\wbarN(\nu')\cap \wbarclsnb(\kappa) = \emptyset$. In particular, by Property~(PD'.\ref{PD1:assign:overlap}),
		this implies that different sibling demands are assigned to different primary demands.

	\end{enumerate}
	
\end{description}

%%%%%%%%%%%%%%%%%

\paragraph{Modified adaptive partitioning.}
To obtain a fractional solution with the above properties,
we employ a modified adaptive partitioning algorithm. As
in Section~\ref{sec: adaptive partitioning}, we have two phases.
In Phase~1 we split clients into demands and create facilities on
sites, while in Phase~2 we augment each demand's
connection values $\barx_{\mu\nu}$ so that its total value is $1$.

Similar to the algorithm in Section~\ref{sec: adaptive partitioning},
Phase~1 runs in iterations. Fix some iteration and consider any client $j$.  As before,
$\wtildeN(j)$ is the neighborhood of $j$ with respect to the yet
unpartitioned solution, namely the set of facilities $\mu$ such that
$\tildex_{\mu j}>0$. Order the facilities in this set as
$\wtildeN(j) = \braced{\mu_1,...,\mu_q}$ with non-decreasing
distance from $j$, that is
$d_{\mu_1 j} \leq d_{\mu_2 j} \leq \ldots \leq d_{\mu_q j}$, where
$q = |\wtildeN(j)|$. Without loss of generality, there is an index
$l$ for which $\sum_{s=1}^l \tildex_{\mu_s j} = 1/\gamma$, since we can
always split one facility to achieve this property. Then we define
$\wtildeN_{\gamma}(j) = \braced{\mu_1,...,\mu_l}$. We also use notation
%
\begin{equation*}
\tcc_\gamma(j) =  D(\wtildeN_\gamma(j), j) = \gamma\sum_{\mu\in\wtildeN_{\gamma}(j)} d_{\mu j} \tildex_{\mu j}
			\quad\textrm{ and }\quad
 \dmax_\gamma(j) = \max_{\mu \in \wtildeN_{\gamma}(j)} d_{\mu j}. 
\end{equation*}
%

When the iteration starts, we first find a not-yet-exhausted client
$p$ that minimizes the value of $\tcc_\gamma(p) + \dmax_\gamma(p)$ and
we create a new demand $\nu$ for $p$.  Now we have two cases:
%
\begin{description}
%
\item{\mycase{1}} $\wtildeN_{\gamma}(p) \cap
  \wbarclsnb(\kappa)\neq\emptyset$, for some existing primary demand
  $\kappa\in P$.  In this case we assign $\nu$ to $\kappa$. As before, if
  there are multiple such $\kappa$, we pick any of them. We also fix
  $\barx_{\mu \nu} \assign \tildex_{\mu p}$ and $\tildex_{\mu p}\assign 0$
  for each $\mu \in \wtildeN(p)\cap \wbarclsnb(\kappa)$. Note that, as before,
  although we check for overlap between $\wtildeN_{\gamma}(p)$ and
  $\wbarclsnb(\kappa)$, the facilities we actually move into
  $\wbarN(\nu)$ include all facilities in the intersection of
  $\wtildeN(p)$, a bigger set, with $\wbarclsnb(\kappa)$.

  At this time, we have the total connection value of $\wbarN(\nu)$ no
  more than $1/\gamma$ since the total connection value of
  $\wbarclsnb(\kappa)$ is $1/\gamma$. Later in Phase 2 we will add
  additional facilities to $\wbarN(\nu)$ to make its total connection
  value equal to $1$. We would like to mention here that facilities
  added later might actually be closer to $\nu$ than some facilities
  currently in $\wbarN(\nu)$.

%
\item{\mycase{2}} $\wtildeN_{\gamma}(p) \cap \wbarclsnb(\kappa) =
  \emptyset$, for all existing primary demands $\kappa$.  In this case
  we make $\nu$ a primary demand (that is, add it to $P$). We then fix $\barx_{\mu \nu}\assign
  \tildex_{\mu p}$ for $\mu \in \wtildeN_{\gamma}(p)$ and set the
  corresponding $\tildex_{\mu p}$ to $0$.  

  It is easy to see that the total connection value of $\wbarN(\nu)$
  is exactly $1/\gamma$. Moreover, facilities remaining in
  $\wtildeN(p)$ are all farther away to $\nu$ than those in
  $\wbarN(\nu)$ already. As we add only facilities from $\wtildeN(p)$
  in Phase 2 to make total connection value of $\wbarN(\nu)$ to $1$,
  we have the current $\wbarN(\nu)$ being exactly $\wbarclsnb(\nu)$
  once phase 2 completes.
%
\end{description}
%
Once all clients are exhausted, that is, each client $j$ has $r_j$
demands created, Phase~1 concludes. We then run Phase~2, the
augmenting phase.  For each demand $\nu\in j$ with total connection
value less than $1$, we use our $\AugmentToUnit()$ procedure to add
additional facilities (possibly split, if necessary) from
$\wtildeN(j)$ to $\wbarN(\nu)$ neighborhood to make $\wbarN(\nu)$'s
total connection value equal $1$. As before a facility is removed from
$\wtildeN(j)$ once it's added to $\wbarN(\nu)$.  This
completes the description of the partitioning algorithm. After that we
will have $\wbarN(\nu), \wbarclsnb(\nu)$ and $\wbarfarnb(\nu)$ fixed
for every demand $\nu$, with $\wbarN(\nu)$ consists of all facilities
$\mu$ such that $\barx_{\mu\nu} > 0$, and the closest few of them to
$\nu$ with total connection value $1/\gamma$ forming $\wbarclsnb(\nu)$
and the rest being $\wbarfarnb(\nu)$.

%%%%%%%

\medskip
\paragraph{Proof of Properties}
We now argue that our partitioned fractional solution $(\barbfx,\barbfy)$
satisfies all the stated properties. Properties~(PS), (CO) are
directly enforced by the algorithm. Property (NB) follows from the
definition of close and far neighborhood.

(PD'.\ref{PD1:disjoint}) holds because $\wbarclsnb(\kappa)$ for a
primary demand $\kappa \in p$ is the same set as $\wtildeN_{\gamma}(p)$ when
$\kappa$ was created. Since the partitioning algorithm makes a demand
primary only if $\wtildeN_{\gamma}(p)$ is disjoint from
$\wbarclsnb(\kappa')$ for all existing primary demands $\kappa'$, we have
(PD'.\ref{PD1:disjoint}) hold.

To see (PD'.\ref{PD1:yi}), we notice that the close neighborhood of
primary demands are disjoint due to (PD'.\ref{PD1:disjoint}). Then
each facility $\mu \in i$ can show up in at most one
$\wbarclsnb(\kappa)$ for some primary demand $\kappa$, and we will have $\bary_{\mu} =
\barx_{\mu\kappa}$ in that case due to (CO). As a result this
summation is no larger than $\sum_{\mu\in i}\bary_{\mu} =
y_i^\ast$. So we have (PD'.\ref{PD1:yi}).

(PD'.\ref{PD1:assign:overlap}) appears to be following from the
algorithm as we only assign a demand $\nu$ to a primary demand
$\kappa$ when $\wbarN(\nu)$ overlaps with
$\wbarclsnb(\kappa)$. However, it is more subtle, as we need
$\wbarclsnb(\nu)$ to overlap with $\wbarclsnb(\kappa)$. For primary
demands, their close neighborhoods contain only facilities added in
Phase 1, because those added in Phase 2 are all farther away. However,
for a non-primary demand $\nu \in j$, $\wbarN(\nu)$ takes all
facilities in $\wbarclsnb(\kappa)\cap \wtildeN(j)$ in Phase 1, which
might be close to $\kappa$ but far from $j$. As a result, facilities
added in the augmenting phase, Phase 2, might appear in
$\wbarclsnb(\nu)$, and some, or maybe all of facilities added to
$\wbarN(\nu)$ in Phase 1 might end up in $\wbarfarnb(\nu)$. This would
make it difficult to satisfy (PD'.\ref{PD:assign:overlap}). We
postpone the proof of this property to Lemma~\ref{lem: PD1: primary
  overlap}.

The proof of (PD'.\ref{PD1:assign:cost}) is similar to that of
Lemma~\ref{lem: PD:assign:cost holds}. Suppose demand $\nu$ is
assigned to primary demand $\kappa$, the idea is that
$\clsdist(\kappa) + \clsmax(\kappa)$ is no more than $\tcc_\gamma(j) +
\dmax_{\gamma}(j)$ when demand $\nu \in j$ was created, which is no
more than $\clsdist(\nu) + \clsmax(\nu)$.

(SI'.\ref{SI1:siblings disjoint}) follows directly from the
algorithm. The proof of (SI'.\ref{SI1:primary disjoint}) is similar to
that of Lemma~\ref{lem: property SI:primary disjoint holds}, by noting
that for a primary demand $\kappa$, $\wbarclsnb(\kappa)$ contains the
same set of facilities as the $\wbarN(\kappa)$ at the end of Phase
1. Moreover, if demand $\nu\in j$ is assigned to primary demand
$\kappa$, then all facilities in $\wtildeN(j)$ that are also in
$\wbarclsnb(\kappa)$ are added to $\wbarN(\kappa)$ in Phase 1. As a
result, if $\nu \in j$ is a non-primary demand and assigned to primary
demand $\kappa$, then facilities added to $\wbarN(\nu')$ for any
$\nu'\in j$ in Phase 2 do not appear in $\wbarclsnb(\kappa)$.


\margincomment{actually, all properties involving close neighborhoods must be justified
because these neighborhoods change in phase 2.}

\begin{lemma} \label{lem: PD1: primary overlap}
  Property (PD'.\ref{PD1:assign:overlap}) holds.
\end{lemma}
\begin{proof}
Consider an iteration when we create a demand $\nu\in p$ and assign it
to $\kappa$. Then the set $B=\wtildeN_{\gamma}(p)\cap
\wbarclsnb(\kappa)$ is not empty.  We claim that $B$ must be a subset
of $\wbarclsnb(\nu)$ after $\wbarN(\nu)$ is finalized with a total
connection value of $1$. To see this, first observe that $B$ is a
subset of $\wbarN(\nu)$, which in turn is a subset of $\wtildeN(p)$,
after taking into account the facility split. (Here $\wtildeN(p)$
refers to the neighborhood of client $p$ just before $\nu$ was created
and $\wbarN(\nu)$ is the final value of this set.)  For an arbitrary
set of facilities $A$ define $\dmax_\gamma(A, \nu)$ as the minimum
$\tau$ such that $\sum_{\mu\in A \suchthat d_{\mu\nu} \leq
  \tau}\;\bary_{\mu} \geq 1/\gamma$.  Adding additional facilities
into $A$ cannot make $\dmax_\gamma(A, \nu)$ larger, so it follows that
$\dmax_\gamma (\wbarclsnb(\nu), \nu) \geq \dmax_\gamma(\wtildeN(p),
\nu)$, because $\wbarclsnb(\nu)$ is a subset of $\wtildeN(p)$. Since,
by definition, for all $\mu$ we have $d_{\mu \nu} = d_{\mu p}$, it is
easy to see that every $\mu \in B$ satisfies $d_{\mu \nu} \leq
\dmax_\gamma(\wtildeN(p), \nu) \leq \dmax_\gamma(\wbarclsnb(\nu),
\nu)$ and hence $B\subseteq \wbarclsnb(\nu)$. We need to be a bit more
careful here when we have a tie in $d_{\mu\nu}$ but we can assume ties
are always broken in favor of facilities in $B$ when defining
$\wbarclsnb(\nu)$. Finally, since $B\neq\emptyset$, we have that
$\wbarclsnb(\nu)\cap \wbarclsnb(\kappa)\neq\emptyset$, which is
Property~(PD.\ref{PD:assign:overlap}).
\end{proof}


Now we have completed the proof of all properties.
%%%%%%%%

\paragraph{Algorithm~{\EBGS}.}
The complete algorithm starts with solving the linear program and
computing the partitioning described earlier in this section.
Given the partitioned fractional solution $(\barbfx,
\barbfy)$ with the desired properties, we then start opening
facilities and making connections to obtain an integral
solution. To this end, for each primary demand $\kappa\in P$,
we open exactly one facility $\phi(\kappa)$ in $\wbarclsnb(\kappa)$,
where each $\mu\in\wbarclsnb(\kappa)$ is chosen as $\phi(\kappa)$ with probability
$\gamma\bary_{\mu}$. For all facilities
 $\mu\in\facilityset - \bigcup_{\kappa\in P}\wbarclsnb(\kappa)$,
we open them independently, each with
probability $\gamma\bary_{\mu}$. 

Next, we connect demands to facilities.
Each primary demand $\kappa\in P$ will connect
to the only open facility $\phi(\kappa)$ in $\wbarclsnb(\kappa)$.  
For each non-primary demand $\nu\notin P$, if
there is an open facility in $\wbarN(\nu)$ then we connect
$\nu$ to the nearest such facility. Otherwise, we connect
$\nu$ to its \emph{target facility} $\phi(\kappa)$, where $\kappa$ is the primary
demand that $\nu$ is assigned to. 

%%%%%%%%%%%

\paragraph{Analysis.}
The feasibility of our integral solution follows from
Properties~(SI'.\ref{SI1:siblings disjoint}), (SI'.\ref{SI1:primary
  disjoint}), and (PD'.\ref{PD1:disjoint}), as these properties together
ensure that each facility is accessible to at most one demand among
all sibling demands of the same client, regardless whether a demand
connects to its neighbor or its target facility.

The expected facility cost of our algorithm is bounded by
$\gamma F^\ast$, using essentially the same argument as in
the previous section (with the factor $\gamma$
accounting for using probabilities $\gamma \bary_{\mu}$
instead of $\bary_{\mu}$).

\margincomment{this needs to be expanded, as in the previous section. add an explicit lemma, etc.}
We now bound the connection
cost. Properties~(PD'.\ref{PD1:assign:overlap}) and
(PD'.\ref{PD1:assign:cost}) allow us to bound the expected
distance from a demand $\nu$ to its target facility by
$\clsdist(\nu)+\clsmax(\nu)+\fardist(\nu)$, in the event
that none of $\nu$'s neighbors opens, using a similar
argument as Lemma 2.2 in~\cite{ByrkaGS10}~\footnote{The full
  proof of the lemma appears in~\cite{ByrkaA10} as
  Lemma~3.3.}. We are then able to estimate the expected
connection cost for demand $\nu$ using an argument similar
to~\cite{ByrkaGS10}: with probability
no less than $1-1/e$, $\nu$ has some facility open in its
close neighborhood, with probability no less than
$1-1/e^\gamma$, $\nu$ has some facility open in its overall
neighborhood, and with probability no more than
$1/e^\gamma$, $\nu$ will connect to its target facility.
This gives us the bound
%
\begin{align}
  \Exp[C_{\nu}] &\leq 
	\textstyle 
	\clsdist(\nu)(1-\frac{1}{e}) + \fardist(\nu)(\frac{1}{e}-\frac{1}{e^\gamma}) 
					+ (\clsdist(\nu)+\clsmax(\nu)+\fardist(\nu))\frac{1}{e^\gamma}
\\
  &\leq 
	\textstyle
	\clsdist(\nu)(1-\frac{1}{e}) + \fardist(\nu)(\frac{1}{e}-\frac{1}{e^\gamma})
	 			+ (\clsdist(\nu)+2\fardist(\nu))\frac{1}{e^\gamma}
\\
  &\leq
	\textstyle
  \concost(\nu)((1-\rho_{\nu})(\frac{1/e+1/e^\gamma}{1-1/\gamma})
  + \rho_{\nu}(1+\frac{2}{e^\gamma}) 
\\
  &\leq 
	\textstyle
	\concost(\nu) \cdot \max\Big\{\frac{1/e+1/e^\gamma}{1-1/\gamma},
  								1+\frac{2}{e^\gamma}\Big\},
\end{align}
%
where $\rho_{\nu}=\clsdist(\nu)/\concost(\nu)$. It is easy
to see that $\rho_{\nu}$ is between 0 and 1.
Since $\sum_{\nu\in j} C^{\avg}(\nu) = \sum_{\nu\in
  j}\sum_{\mu\in\facilityset} d_{\mu\nu}\barx_{\mu\nu} =
\sum_{i\in\sitesset} d_{ij}x_{ij}^\ast = C_j^\ast$, summing
over all clients $j$ we have total connection cost bounded
by $C^\ast \max\{\frac{1/e+1/e^\gamma}{1-1/\gamma},
1+\frac{2}{e^\gamma}\}$. The expected facility cost is
bounded by $\gamma F^\ast$, as argued earlier. Hence the
total cost is bounded by $\max\{\gamma,
\frac{1/e+1/e^\gamma}{1-1/\gamma},
1+\frac{2}{e^\gamma}\}\cdot \LP^\ast$. Picking
$\gamma=1.575$ we obtain the desired ratio.


\begin{theorem}\label{thm:ebgs}
  Algorithm~{\EBGS} is a $1.575$-approximation algorithm for \FTFP.
\end{theorem}



